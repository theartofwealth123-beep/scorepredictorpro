<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ScorePredictor Pro</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top, #1e40af 0%, #0f172a 55%, #020617 100%);
      min-height: 100vh;
      padding: 20px;
      color: white;
    }
    .container { max-width: 1200px; margin: 0 auto; }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .brand {
      font-weight: 800;
      letter-spacing: 0.12em;
      font-size: 0.95rem;
      text-transform: uppercase;
      opacity: 0.9;
    }
    .auth-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 0.9rem;
    }
    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .btn-outline {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.5);
      color: white;
    }
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      color: white;
    }
    .btn-danger {
      background: rgba(248, 113, 113, 0.9);
      color: white;
    }
    .user-label {
      opacity: 0.8;
      font-size: 0.8rem;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      margin-left: 6px;
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(16, 185, 129, 0.6);
    }

    .header { text-align: center; margin-bottom: 18px; }
    h1 { font-size: 2.2rem; margin-bottom: 8px; }
    .subtitle { color: #93c5fd; font-size: 0.95rem; opacity: 0.9; }

    .paywall-card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid rgba(251, 191, 36, 0.8);
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
    }
    .paywall-title { font-size: 1.2rem; margin-bottom: 6px; }
    .paywall-subtitle {
      font-size: 0.9rem;
      opacity: 0.85;
      margin-bottom: 14px;
    }
    .paywall-list {
      font-size: 0.85rem;
      opacity: 0.9;
      margin-bottom: 14px;
      padding-left: 18px;
    }
    .paywall-list li { margin-bottom: 4px; }
    .paywall-badge {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(52, 211, 153, 0.2);
      border: 1px solid rgba(52, 211, 153, 0.7);
      margin-bottom: 8px;
    }
    .trial-status {
      font-size: 0.85rem;
      opacity: 0.9;
      margin-top: 4px;
    }

    .input-section {
      background: rgba(15, 23, 42, 0.88);
      backdrop-filter: blur(14px);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    .form-group { display: flex; flex-direction: column; }
    label { font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }
    select {
      padding: 10px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.9);
      color: white;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 0.9rem;
    }
    select option { background: #020617; color: white; }
    .predict-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #22c55e 0%, #3b82f6 40%, #8b5cf6 100%);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      letter-spacing: 0.03em;
    }
    .predict-btn:hover { transform: scale(1.02); }

    .results { display: none; }
    .results.show { display: block; }

    .score-card {
      background: radial-gradient(circle at top left, #22c55e 0%, #15803d 40%, #064e3b 100%);
      border-radius: 22px;
      padding: 26px;
      margin-bottom: 24px;
      text-align: center;
      box-shadow: 0 22px 50px rgba(0,0,0,0.6);
    }
    .confidence {
      display: inline-block;
      background: rgba(15, 23, 42, 0.35);
      padding: 6px 18px;
      border-radius: 20px;
      margin: 16px 0;
      font-size: 0.85rem;
      border: 1px solid rgba(15, 23, 42, 0.6);
    }
    .scores {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 20px;
      align-items: center;
      margin-top: 20px;
    }
    .team-score {
      background: rgba(15, 23, 42, 0.35);
      border-radius: 15px;
      padding: 18px;
    }
    .team-name { font-size: 1.05rem; margin-bottom: 4px; }
    .score { font-size: 2.8rem; font-weight: 800; }
    .winner-info { text-align: center; }
    .winner-name { font-size: 1.4rem; font-weight: 800; margin: 6px 0; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    .stat-card h3 { font-size: 1.05rem; margin-bottom: 12px; }
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.18);
      font-size: 0.9rem;
    }
    .stat-row:last-child { border-bottom: none; }

    .methodology {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 20px;
      padding: 20px;
      font-size: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    /* Auth modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-backdrop.show { display: flex; }
    .modal {
      background: #020617;
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 380px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    .modal h2 { font-size: 1.3rem; margin-bottom: 4px; }
    .modal-desc {
      font-size: 0.85rem;
      opacity: 0.8;
      margin-bottom: 16px;
    }
    .modal .form-group { margin-bottom: 12px; }
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.8);
      color: white;
      font-size: 0.9rem;
    }
    .modal-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }
    .modal-footer-text {
      font-size: 0.8rem;
      text-align: center;
      margin-top: 10px;
      opacity: 0.8;
    }
    .link {
      color: #93c5fd;
      text-decoration: underline;
      text-decoration-style: dotted;
      cursor: pointer;
    }
    .error-text {
      color: #fecaca;
      font-size: 0.8rem;
      margin-top: 4px;
      min-height: 1em;
    }

    @media (max-width: 768px) {
      h1 { font-size: 1.7rem; }
      .scores { grid-template-columns: 1fr; }
      .score { font-size: 2.4rem; }
      .top-bar { flex-direction: column; align-items: flex-start; gap: 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Top bar -->
    <div class="top-bar">
      <div class="brand">ScorePredictor Pro</div>
      <div class="auth-buttons" id="authControls"></div>
    </div>

    <div class="header">
      <h1>âš¡ Sports Score Predictor</h1>
      <p class="subtitle">Advanced statistical predictions across NFL, NBA, MLB, NCAAF & NCAAB</p>
    </div>

    <!-- PAYWALL SCREEN -->
    <div id="paywall">
      <div class="paywall-card">
        <div class="paywall-badge">3-Day Free Trial</div>
        <h2 class="paywall-title">Unlock ScorePredictor Pro</h2>
        <p class="paywall-subtitle">
          Start your free 3-day trial â€” no payment required. Log in any time with your account
          or use your admin login for unlimited access.
        </p>
        <ul class="paywall-list">
          <li>Unlimited predictions for NFL, NBA, MLB, NCAAF, and NCAAB.</li>
          <li>Model blends efficiency, pace, strength of schedule & form.</li>
          <li>Admin-controlled access â€“ keep your edge private.</li>
        </ul>
        <button class="btn btn-primary" onclick="openAuthModal('signup')">Start Free Trial</button>
        <button class="btn btn-outline" onclick="openAuthModal('login')" style="margin-left:8px;margin-top:8px;">
          Log In
        </button>
        <p class="trial-status" id="trialStatusText"></p>
      </div>
    </div>

    <!-- MAIN APP (GATED) -->
    <div id="appContent" style="display:none;">
      <div class="input-section">
        <div class="form-grid">
          <div class="form-group">
            <label>League</label>
            <select id="league">
              <option value="NFL">NFL</option>
              <option value="NBA">NBA</option>
              <option value="MLB">MLB</option>
              <option value="NCAAF">NCAAF</option>
              <option value="NCAAB">NCAAB</option>
            </select>
          </div>

          <div class="form-group">
            <label>Home Team</label>
            <select id="homeTeam">
              <option value="">Loading teamsâ€¦</option>
            </select>
          </div>

          <div class="form-group">
            <label>Away Team</label>
            <select id="awayTeam">
              <option value="">Loading teamsâ€¦</option>
            </select>
          </div>
        </div>
        <button class="predict-btn" onclick="predictScore()">ðŸŽ¯ Generate Prediction</button>
      </div>

      <div id="results" class="results">
        <div class="score-card">
          <h2>Predicted Final Score</h2>
          <div class="confidence" id="confidence"></div>
          <div class="scores">
            <div class="team-score">
              <div class="team-name" id="homeTeamName"></div>
              <div class="score" id="homeScore"></div>
              <div style="opacity:0.8;">Home</div>
            </div>
            <div class="winner-info">
              <div style="opacity:0.8;">Winner</div>
              <div class="winner-name" id="winner"></div>
              <div style="opacity:0.8;" id="spread"></div>
            </div>
            <div class="team-score">
              <div class="team-name" id="awayTeamName"></div>
              <div class="score" id="awayScore"></div>
              <div style="opacity:0.8;">Away</div>
            </div>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <h3 id="homeStatsTitle"></h3>
            <div id="homeStats"></div>
          </div>
          <div class="stat-card">
            <h3 id="awayStatsTitle"></h3>
            <div id="awayStats"></div>
          </div>
        </div>

        <div class="methodology">
          <h3>Model Explanation</h3>
          <p id="reasoningText" style="margin-top:8px; opacity:0.9;"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth modal -->
  <div id="authModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2 id="authModalTitle">Sign in</h2>
      <p class="modal-desc" id="authModalDesc"></p>
      <div class="form-group">
        <label for="authEmail">Email</label>
        <input type="email" id="authEmail" placeholder="you@example.com" />
      </div>
      <div class="form-group">
        <label for="authPassword">Password</label>
        <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
      </div>
      <div class="error-text" id="authError"></div>
      <div class="modal-actions">
        <button class="btn btn-primary" id="authPrimaryBtn"></button>
        <button class="btn btn-outline" onclick="closeAuthModal()">Cancel</button>
      </div>
      <div class="modal-footer-text">
        <span id="authToggleText"></span>
        <span class="link" id="authToggleLink" onclick="toggleAuthMode()"></span>
      </div>
    </div>
  </div>

  <script>
  /************* AUTH + TRIAL LAYER *************/
  const ADMIN_EMAIL = "ben_sovilla@yahoo.com";
  const TRIAL_DAYS = 3;
  let authMode = "login";

  function getUsers() {
    try { return JSON.parse(localStorage.getItem("sp_users") || "{}"); }
    catch { return {}; }
  }
  function saveUsers(users) {
    localStorage.setItem("sp_users", JSON.stringify(users));
  }
  function getCurrentUser() {
    try { return JSON.parse(localStorage.getItem("sp_currentUser") || "null"); }
    catch { return null; }
  }
  function setCurrentUser(user) {
    if (user) localStorage.setItem("sp_currentUser", JSON.stringify(user));
    else localStorage.removeItem("sp_currentUser");
    renderAuthUI();
    checkAccessAndRender();
  }
  function isTrialActive(user) {
    if (!user || !user.trialStart) return false;
    const start = new Date(user.trialStart).getTime();
    const now = Date.now();
    const diffDays = (now - start) / (1000 * 60 * 60 * 24);
    return diffDays < TRIAL_DAYS;
  }
  function remainingTrialText(user) {
    if (!user || !user.trialStart) return "No trial started yet.";
    const start = new Date(user.trialStart).getTime();
    const now = Date.now();
    const diffMs = start + TRIAL_DAYS * 24 * 60 * 60 * 1000 - now;
    if (diffMs <= 0) return "Your free trial has expired.";
    const remainingDays = diffMs / (1000 * 60 * 60 * 24);
    const days = Math.floor(remainingDays);
    const hours = Math.floor((remainingDays - days) * 24);
    if (days <= 0) return `Trial active: about ${hours}h left`;
    return `Trial active: about ${days}d ${hours}h left`;
  }
  function userHasAccess(user) {
    if (!user) return false;
    if (user.isAdmin) return true;
    if (user.isSubscribed) return true;
    if (isTrialActive(user)) return true;
    return false;
  }
  function renderAuthUI() {
    const user = getCurrentUser();
    const authControls = document.getElementById("authControls");
    const paywallTrialText = document.getElementById("trialStatusText");
    if (!authControls) return;

    if (!user) {
      authControls.innerHTML = `
        <button class="btn btn-outline" onclick="openAuthModal('login')">Log in</button>
        <button class="btn btn-primary" onclick="openAuthModal('signup')">Start Free Trial</button>
      `;
      if (paywallTrialText) {
        paywallTrialText.textContent = "Not signed in. Create an account to start your free 3-day trial.";
      }
    } else {
      const accessText = userHasAccess(user)
        ? (isTrialActive(user) && !user.isSubscribed && !user.isAdmin
            ? remainingTrialText(user)
            : (user.isSubscribed ? "Subscription active." : "Admin access."))
        : "No active trial or subscription.";

      const roleBadge = user.isAdmin
        ? '<span class="badge">Admin</span>'
        : user.isSubscribed
        ? '<span class="badge">Subscriber</span>'
        : isTrialActive(user)
        ? '<span class="badge">Trial</span>'
        : "";

      authControls.innerHTML = `
        <div class="user-label">
          Signed in as ${user.email}${roleBadge}
        </div>
        ${!user.isSubscribed && !user.isAdmin ? `
          <button class="btn btn-primary" onclick="fakeSubscribe()">Subscribe now</button>
        ` : ""}
        <button class="btn btn-danger" onclick="logout()">Log out</button>
      `;

      if (paywallTrialText) {
        paywallTrialText.textContent = accessText;
      }
    }
  }
  function checkAccessAndRender() {
    const user = getCurrentUser();
    const appContent = document.getElementById("appContent");
    const paywall = document.getElementById("paywall");
    if (!appContent || !paywall) return;
    if (userHasAccess(user)) {
      appContent.style.display = "block";
      paywall.style.display = "none";
    } else {
      appContent.style.display = "none";
      paywall.style.display = "block";
    }
  }
  function openAuthModal(mode) {
    authMode = mode || "login";
    const backdrop = document.getElementById("authModalBackdrop");
    const title = document.getElementById("authModalTitle");
    const desc = document.getElementById("authModalDesc");
    const primaryBtn = document.getElementById("authPrimaryBtn");
    const toggleText = document.getElementById("authToggleText");
    const toggleLink = document.getElementById("authToggleLink");
    const error = document.getElementById("authError");

    document.getElementById("authEmail").value = "";
    document.getElementById("authPassword").value = "";
    error.textContent = "";

    if (authMode === "login") {
      title.textContent = "Sign in to your account";
      desc.textContent = "Access your subscription or continue your free trial.";
      primaryBtn.textContent = "Sign in";
      toggleText.textContent = "Don't have an account?";
      toggleLink.textContent = "Create one";
    } else {
      title.textContent = "Create your account";
      desc.textContent = "Start your 3-day free trial. No payment required to begin.";
      primaryBtn.textContent = "Create account";
      toggleText.textContent = "Already have an account?";
      toggleLink.textContent = "Sign in";
    }

    primaryBtn.onclick = handleAuthSubmit;
    backdrop.classList.add("show");
  }
  function closeAuthModal() {
    document.getElementById("authModalBackdrop").classList.remove("show");
  }
  function toggleAuthMode() {
    authMode = authMode === "login" ? "signup" : "login";
    openAuthModal(authMode);
  }
  function handleAuthSubmit() {
    const email = document.getElementById("authEmail").value.trim().toLowerCase();
    const password = document.getElementById("authPassword").value;
    const error = document.getElementById("authError");
    error.textContent = "";
    if (!email || !password) {
      error.textContent = "Please enter email and password.";
      return;
    }
    const users = getUsers();
    if (authMode === "signup") {
      if (users[email]) {
        error.textContent = "An account with this email already exists. Try signing in.";
        return;
      }
      const newUser = {
        email,
        password,
        isAdmin: email === ADMIN_EMAIL,
        isSubscribed: false,
        trialStart: new Date().toISOString()
      };
      users[email] = newUser;
      saveUsers(users);
      setCurrentUser(newUser);
      closeAuthModal();
    } else {
      const existing = users[email];
      if (!existing || existing.password !== password) {
        error.textContent = "Invalid email or password.";
        return;
      }
      existing.isAdmin = email === ADMIN_EMAIL;
      users[email] = existing;
      saveUsers(users);
      setCurrentUser(existing);
      closeAuthModal();
    }
  }
  function logout() {
    setCurrentUser(null);
  }
  function fakeSubscribe() {
    const user = getCurrentUser();
    if (!user) return openAuthModal("signup");
    const users = getUsers();
    user.isSubscribed = true;
    users[user.email] = user;
    saveUsers(users);
    setCurrentUser(user);
    alert("Subscription activated (demo). In production this would happen after payment.");
  }

  /************* LEAGUE CONFIG (USED BY MONTE CARLO) *************/
  // Tuned to keep totals + spreads in realistic ranges per league
  const LEAGUE_PARAMS = {
    NFL: {
      avgTotal: 44,
      minTotal: 30,
      maxTotal: 62,
      homeAdv: 2.5,
      totalSigma: 7,
      spreadSigma: 10,
      marginScale: 7,
      maxMargin: 21
    },
    NBA: {
      avgTotal: 228,
      minTotal: 205,
      maxTotal: 260,
      homeAdv: 2.5,
      totalSigma: 10,
      spreadSigma: 11,
      marginScale: 6.5,
      maxMargin: 22
    },
    MLB: {
      avgTotal: 9,
      minTotal: 5,
      maxTotal: 15,
      homeAdv: 0.4,
      totalSigma: 2.2,
      spreadSigma: 1.8,
      marginScale: 2.2,
      maxMargin: 5
    },
    NCAAF: {
      avgTotal: 55,
      minTotal: 35,
      maxTotal: 82,
      homeAdv: 3.5,
      totalSigma: 10,
      spreadSigma: 14,
      marginScale: 9,
      maxMargin: 32
    },
    NCAAB: {
      avgTotal: 143,
      minTotal: 120,
      maxTotal: 190,
      homeAdv: 3.8,
      totalSigma: 11,
      spreadSigma: 13,
      marginScale: 7.5,
      maxMargin: 28
    }
  };

  /************* TEAM LISTS (data/all-teams.json) *************/
  let ALL_TEAMS = {};
  let teamsLoaded = false;

  async function loadAllTeams() {
    const leagueSel = document.getElementById('league');
    const homeSel = document.getElementById('homeTeam');
    const awaySel = document.getElementById('awayTeam');
    if (!leagueSel || !homeSel || !awaySel) return;

    homeSel.innerHTML = '<option value="">Loading teamsâ€¦</option>';
    awaySel.innerHTML = '<option value="">Loading teamsâ€¦</option>';
    homeSel.disabled = true;
    awaySel.disabled = true;

    try {
      // all-teams.json should sit next to index.html in Netlify
          const res = await fetch('/data/all-teams.json');
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      ALL_TEAMS = data || {};
      teamsLoaded = true;

      if (!ALL_TEAMS[leagueSel.value]) {
        const leagues = Object.keys(ALL_TEAMS);
        if (leagues.length) leagueSel.value = leagues[0];
      }

      populateTeamDropdowns();
    } catch (err) {
      console.error(err);
      homeSel.innerHTML = '<option value="">Error loading teams</option>';
      awaySel.innerHTML = '<option value="">Error loading teams</option>';
      alert('Error loading team list: ' + err.message);
    }
  }

  function populateTeamDropdowns() {
    const leagueSel = document.getElementById('league');
    const homeSel = document.getElementById('homeTeam');
    const awaySel = document.getElementById('awayTeam');
    if (!leagueSel || !homeSel || !awaySel) return;

    const league = leagueSel.value;
    const teams = ALL_TEAMS[league] || [];

    homeSel.innerHTML = '<option value="">Select Home Team</option>';
    awaySel.innerHTML = '<option value="">Select Away Team</option>';

    teams.forEach(name => {
      const optH = document.createElement('option');
      optH.value = name;
      optH.textContent = name;
      homeSel.appendChild(optH);

      const optA = document.createElement('option');
      optA.value = name;
      optA.textContent = name;
      awaySel.appendChild(optA);
    });

    homeSel.disabled = false;
    awaySel.disabled = false;
  }

  /************* FETCH TEAM STATS FROM NETLIFY FUNCTION *************/
  async function fetchTeamStats(league, teamName) {
const url = `/.netlify/functions/teams-stats?league=${encodeURIComponent(league)}&team=${encodeURIComponent(teamName)}`;
    const res = await fetch(url);
    if (!res.ok) {
      throw new Error(`Stats API error for ${teamName}: ${res.status} ${res.statusText}`);
    }
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    const required = ["off_index", "def_index", "pace_index", "sos_index", "form_index", "ppg", "opp_ppg"];
    for (const key of required) {
      if (typeof data[key] !== "number") {
        throw new Error(`Missing or invalid "${key}" in stats response for ${teamName}`);
      }
    }

    return {
      league: data.league || league,
      team: data.team || teamName,
      off_index: data.off_index,
      def_index: data.def_index,
      pace_index: data.pace_index,
      sos_index: data.sos_index,
      form_index: data.form_index,
      ppg: data.ppg,
      opp_ppg: data.opp_ppg,
      home_adv_points: typeof data.home_adv_points === "number" ? data.home_adv_points : 0
    };
  }

  /************* RANDOM NORMAL HELPER (Boxâ€“Muller) *************/
  function randomNormal() {
    let u = 0, v = 0;
    while (u === 0) u = Math.random();
    while (v === 0) v = Math.random();
    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
  }

  /************* PREDICTION MODEL (ADVANCED MONTE CARLO) *************/
  function predictFromStats(home, away, league) {
    const cfg = LEAGUE_PARAMS[league] || {
      avgTotal: 40,
      minTotal: 20,
      maxTotal: 80,
      homeAdv: 0,
      totalSigma: 8,
      spreadSigma: 10,
      marginScale: 6,
      maxMargin: 25
    };

    // 1) BASE TOTAL: blend league baseline with actual PPG of these teams
    const teamTotal = (home.ppg || cfg.avgTotal / 2) + (away.ppg || cfg.avgTotal / 2);
    let baseTotal = 0.5 * cfg.avgTotal + 0.5 * teamTotal;

    if (baseTotal < cfg.minTotal) baseTotal = cfg.minTotal;
    if (baseTotal > cfg.maxTotal) baseTotal = cfg.maxTotal;

    // 2) RATING FOR EACH TEAM (offense vs opponent defense, plus schedule)
    const safeOppPpgHome = home.opp_ppg || (cfg.avgTotal / 2);
    const safeOppPpgAway = away.opp_ppg || (cfg.avgTotal / 2);

    const offRatingHome = (home.off_index || 1) * (home.ppg || cfg.avgTotal / 2) / safeOppPpgHome;
    const offRatingAway = (away.off_index || 1) * (away.ppg || cfg.avgTotal / 2) / safeOppPpgAway;

    const sosAdjHome = home.sos_index ? (0.7 + 0.6 * home.sos_index) : 1.0;
    const sosAdjAway = away.sos_index ? (0.7 + 0.6 * away.sos_index) : 1.0;

    const ratingHome = offRatingHome * sosAdjHome;
    const ratingAway = offRatingAway * sosAdjAway;

    const safeRatingHome = Number.isFinite(ratingHome) && ratingHome > 0 ? ratingHome : 1;
    const safeRatingAway = Number.isFinite(ratingAway) && ratingAway > 0 ? ratingAway : 1;

    // 3) EXPECTED MARGIN via log ratio
    const ratio = safeRatingHome / safeRatingAway;
    let marginMean = cfg.marginScale * Math.log(ratio);

    // home-field
    marginMean += cfg.homeAdv;

    if (marginMean > cfg.maxMargin) marginMean = cfg.maxMargin;
    if (marginMean < -cfg.maxMargin) marginMean = -cfg.maxMargin;

    // 4) MONTE CARLO SIMULATION
    const iterations = 20000;

    let sumHome = 0;
    let sumAway = 0;
    let homeWins = 0;

    for (let i = 0; i < iterations; i++) {
      let total = baseTotal + randomNormal() * cfg.totalSigma;
      if (total < cfg.minTotal) total = cfg.minTotal;
      if (total > cfg.maxTotal) total = cfg.maxTotal;

      let margin = marginMean + randomNormal() * cfg.spreadSigma;

      let homeScore = (total + margin) / 2;
      let awayScore = total - homeScore;

      if (homeScore < 0) homeScore = 0;
      if (awayScore < 0) awayScore = 0;

      sumHome += homeScore;
      sumAway += awayScore;
      if (homeScore > awayScore) homeWins++;
    }

    let homeScoreAvg = sumHome / iterations;
    let awayScoreAvg = sumAway / iterations;

    homeScoreAvg = Math.round(homeScoreAvg * 10) / 10;
    awayScoreAvg = Math.round(awayScoreAvg * 10) / 10;

    const spread = Math.abs(homeScoreAvg - awayScoreAvg);
    const winner = homeScoreAvg >= awayScoreAvg ? home.team : away.team;
    const homeWinProb = homeWins / iterations;

    let confidence;
    const vol = cfg.spreadSigma || 10;
    if (spread >= vol * 0.8) confidence = "High";
    else if (spread >= vol * 0.4) confidence = "Medium";
    else confidence = "Low";

    const envTotal = (sumHome + sumAway) / iterations;
    const avgPaceIdx = (home.pace_index + away.pace_index) / 2 || 1.0;
    const avgSosIdx = (home.sos_index + away.sos_index) / 2 || 1.0;
    const offVsDefHome = safeRatingHome;
    const offVsDefAway = safeRatingAway;
    const shareHome = homeScoreAvg / (homeScoreAvg + awayScoreAvg || 1);
    const shareAway = 1 - shareHome;

    return {
      homeScore: homeScoreAvg,
      awayScore: awayScoreAvg,
      winner,
      spread,
      confidence,
      debug: {
        baseTotal,
        envTotal,
        avgPaceIdx,
        avgSosIdx,
        offVsDefHome,
        offVsDefAway,
        shareHome,
        shareAway,
        homeWinProb
      }
    };
  }

  /************* PREDICT BUTTON HANDLER *************/
  async function predictScore() {
    const league = document.getElementById('league').value;
    const homeTeam = document.getElementById('homeTeam').value.trim();
    const awayTeam = document.getElementById('awayTeam').value.trim();
    if (!homeTeam || !awayTeam) {
      alert('Select both teams from the dropdowns.');
      return;
    }
    if (homeTeam.toLowerCase() === awayTeam.toLowerCase()) {
      alert('Teams must be different.');
      return;
    }
    try {
      document.getElementById('confidence').textContent = 'Loading stats...';
      const [homeStats, awayStats] = await Promise.all([
        fetchTeamStats(league, homeTeam),
        fetchTeamStats(league, awayTeam)
      ]);

      const result = predictFromStats(homeStats, awayStats, league);

      document.getElementById('confidence').textContent = result.confidence + ' confidence';
      document.getElementById('homeTeamName').textContent = homeStats.team + " (Home)";
      document.getElementById('awayTeamName').textContent = awayStats.team + " (Away)";
      document.getElementById('homeScore').textContent = result.homeScore;
      document.getElementById('awayScore').textContent = result.awayScore;
      document.getElementById('winner').textContent = result.winner;
      document.getElementById('spread').textContent = 'Spread: ' + result.spread.toFixed(1);

      document.getElementById('homeStatsTitle').textContent = homeStats.team + ' Profile';
      document.getElementById('homeStats').innerHTML = `
        <div class="stat-row"><span>Off Index</span><span>${homeStats.off_index.toFixed(3)}</span></div>
        <div class="stat-row"><span>Def Index</span><span>${homeStats.def_index.toFixed(3)}</span></div>
        <div class="stat-row"><span>Pace Index</span><span>${homeStats.pace_index.toFixed(3)}</span></div>
        <div class="stat-row"><span>SOS Index</span><span>${homeStats.sos_index.toFixed(3)}</span></div>
        <div class="stat-row"><span>Form Index</span><span>${homeStats.form_index.toFixed(3)}</span></div>
        <div class="stat-row"><span>PPG</span><span>${homeStats.ppg.toFixed(1)}</span></div>
        <div class="stat-row"><span>Opp PPG</span><span>${homeStats.opp_ppg.toFixed(1)}</span></div>
      `;
      document.getElementById('awayStatsTitle').textContent = awayStats.team + ' Profile';
      document.getElementById('awayStats').innerHTML = `
        <div class="stat-row"><span>Off Index</span><span>${awayStats.off_index.toFixed(3)}</span></div>
        <div class="stat-row"><span>Def Index</span><span>${awayStats.def_index.toFixed(3)}</span></div>
        <div class="stat-row"><span>Pace Index</span><span>${awayStats.pace_index.toFixed(3)}</span></div>
        <div class="stat-row"><span>SOS Index</span><span>${awayStats.sos_index.toFixed(3)}</span></div>
        <div class="stat-row"><span>Form Index</span><span>${awayStats.form_index.toFixed(3)}</span></div>
        <div class="stat-row"><span>PPG</span><span>${awayStats.ppg.toFixed(1)}</span></div>
        <div class="stat-row"><span>Opp PPG</span><span>${awayStats.opp_ppg.toFixed(1)}</span></div>
      `;

      const d = result.debug;
      const winPct = (d.homeWinProb * 100).toFixed(1);
      const reasoning = `
        Base total (from league + team PPG) is ${d.baseTotal.toFixed(1)} points. After adjusting for pace
        (${d.avgPaceIdx.toFixed(2)}Ã—) and strength of schedule (${d.avgSosIdx.toFixed(2)}Ã—), the simulated game
        environment averages ${d.envTotal.toFixed(1)} total points across 20,000 Monte Carlo runs.
        Matchup ratings give ${homeStats.team} an effective strength of ${d.offVsDefHome.toFixed(2)} versus
        ${d.offVsDefAway.toFixed(2)} for ${awayStats.team}. The model allocates roughly
        ${(d.shareHome * 100).toFixed(1)}% of points to ${homeStats.team} and
        ${(d.shareAway * 100).toFixed(1)}% to ${awayStats.team}, with a home win probability of
        ${winPct}% and an implied spread of ${result.spread.toFixed(1)}.
      `;
      document.getElementById('reasoningText').textContent = reasoning.replace(/\s+/g, " ").trim();
      document.getElementById('results').classList.add('show');
      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
      console.error(err);
      alert('Could not load stats or compute prediction. Check league/team and try again.');
    }
  }

  /************* INIT *************/
  document.addEventListener("DOMContentLoaded", () => {
    renderAuthUI();
    checkAccessAndRender();
    loadAllTeams();

    const leagueSel = document.getElementById('league');
    if (leagueSel) {
      leagueSel.addEventListener('change', () => {
        if (teamsLoaded) populateTeamDropdowns();
      });
    }
  });
</script>
</body>
</html>
