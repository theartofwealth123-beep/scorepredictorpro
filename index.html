<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ScorePredictor Pro • 50K Sims</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      /* background set via utility class */
      color: #e5e7eb;
    }
    .gradient-btn {
      background: linear-gradient(135deg, #6366f1, #ec4899);
      box-shadow: 0 10px 25px rgba(79, 70, 229, 0.6);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .gradient-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 35px rgba(79, 70, 229, 0.85);
    }
  </style>
</head>
<body class="min-h-screen bg-black flex flex-col">
  <!-- NAV -->
  <header class="border-b border-slate-800/60 bg-black/80 backdrop-blur sticky top-0 z-50">
    <div class="max-w-6xl mx-auto flex items-center justify-between px-4 py-3">
      <div class="flex items-center gap-2">
        <a href="/" class="text-xl font-black tracking-tight bg-gradient-to-r from-sky-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
          ScorePredictor Pro
        </a>
      </div>
      <nav class="hidden md:flex items-center gap-2 text-sm font-medium text-slate-400">
        <a href="/" class="px-3 py-1.5 rounded-full bg-slate-800 text-slate-100 transition-colors">Calculator</a>
        <a href="/games.html" class="px-3 py-1.5 rounded-full hover:bg-slate-800/50 hover:text-slate-200 transition-colors">Live Games</a>
        <a href="/freepicks.html" class="px-3 py-1.5 rounded-full hover:bg-slate-800/50 hover:text-slate-200 transition-colors">Free Picks</a>
        <a href="/news.html" class="px-3 py-1.5 rounded-full hover:bg-slate-800/50 hover:text-slate-200 transition-colors">News</a>
        <a href="/profile.html" class="px-3 py-1.5 rounded-full hover:bg-slate-800/50 hover:text-slate-200 transition-colors">Profile</a>
      </nav>
      <!-- Mobile Menu -->
      <nav class="md:hidden flex gap-3 text-xs font-semibold text-slate-400">
        <a href="/games.html">Games</a>
        <a href="/freepicks.html">Picks</a>
        <a href="/news.html">News</a>
      </nav>
    </div>
  </header>

  <div class="flex-grow flex items-center justify-center px-4 py-8">
    <div class="w-full max-w-5xl space-y-8">
      <!-- Header -->
      <header class="text-center space-y-2">
        <h1 class="text-4xl md:text-5xl font-black tracking-tight bg-gradient-to-r from-purple-400 via-pink-500 to-sky-400 bg-clip-text text-transparent">
          ScorePredictor Pro
        </h1>
        <p class="text-xs md:text-sm text-emerald-400 font-semibold tracking-[0.25em] uppercase">
          500,000 Simulations • Admin
        </p>
      </header>

      <!-- Main Card -->
      <main class="bg-slate-900/80 border border-slate-700/70 rounded-3xl shadow-xl p-5 md:p-7 space-y-6">
        <!-- League & Teams -->
        <section class="grid md:grid-cols-3 gap-4 md:gap-6">
          <div class="space-y-1">
            <label for="league" class="block text-[0.65rem] font-semibold uppercase tracking-wide text-slate-400">
              League
            </label>
            <select
              id="league"
              class="w-full bg-slate-900/70 border border-slate-700 rounded-2xl px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/70"
            >
              <option value="NBA">NBA</option>
              <option value="NFL">NFL</option>
              <option value="NHL">NHL</option>
              <option value="MLB">MLB</option>
              <option value="NCAAB">NCAAB</option>
              <option value="NCAAF">NCAAF</option>
            </select>
          </div>

          <div class="space-y-1">
            <label for="home-team" class="block text-[0.65rem] font-semibold uppercase tracking-wide text-slate-400">
              Home Team
            </label>
            <select
              id="home-team"
              class="w-full bg-slate-900/70 border border-slate-700 rounded-2xl px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/70"
            >
              <option>Select Home Team</option>
            </select>
          </div>

          <div class="space-y-1">
            <label for="away-team" class="block text-[0.65rem] font-semibold uppercase tracking-wide text-slate-400">
              Away Team
            </label>
            <select
              id="away-team"
              class="w-full bg-slate-900/70 border border-slate-700 rounded-2xl px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/70"
            >
              <option>Select Away Team</option>
            </select>
          </div>
        </section>

        <!-- Odds Inputs (optional) -->
        <section class="grid md:grid-cols-4 gap-4 text-sm">
          <div class="space-y-1">
            <label for="home-ml" class="block text-[0.65rem] font-semibold uppercase tracking-wide text-slate-400">
              Home Moneyline
            </label>
            <input
              id="home-ml"
              type="number"
              class="w-full bg-slate-900/70 border border-slate-700 rounded-2xl px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-purple-500/70"
              placeholder="-150"
            />
          </div>

          <div class="space-y-1">
            <label for="away-ml" class="block text-[0.65rem] font-semibold uppercase tracking-wide text-slate-400">
              Away Moneyline
            </label>
            <input
              id="away-ml"
              type="number"
              class="w-full bg-slate-900/70 border border-slate-700 rounded-2xl px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-purple-500/70"
              placeholder="+130"
            />
          </div>

          <div class="space-y-1">
            <label for="spread-line" class="block text-[0.65rem] font-semibold uppercase tracking-wide text-slate-400">
              Home Spread
            </label>
            <input
              id="spread-line"
              type="number"
              step="0.5"
              class="w-full bg-slate-900/70 border border-slate-700 rounded-2xl px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-purple-500/70"
              placeholder="-4.5"
            />
          </div>

          <div class="space-y-1">
            <label for="total-line" class="block text-[0.65rem] font-semibold uppercase tracking-wide text-slate-400">
              Total (O/U)
            </label>
            <input
              id="total-line"
              type="number"
              step="0.5"
              class="w-full bg-slate-900/70 border border-slate-700 rounded-2xl px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-purple-500/70"
              placeholder="229.5"
            />
          </div>
        </section>

        <!-- Match Context (Injuries / Neutral) -->
        <section class="bg-slate-950/40 border border-slate-800 rounded-2xl p-4 space-y-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <p class="text-[0.7rem] font-semibold uppercase tracking-wide text-slate-300">
              Context & Injury Adjustments
            </p>
            <p class="text-[0.7rem] text-slate-400">
              Position-level injuries are available for NBA & NFL. Others use the quick toggles.
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
            <!-- Neutral Site Toggle -->
            <div class="flex items-center justify-center md:justify-start">
              <label class="inline-flex items-center cursor-pointer group">
                <input id="neutral-site" type="checkbox" class="sr-only peer">
                <div class="relative w-11 h-6 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-purple-500 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                <span class="ms-3 text-sm font-medium text-slate-300 group-hover:text-white transition-colors">Neutral Site</span>
              </label>
            </div>

            <!-- Home Injuries (generic) -->
            <div id="generic-injuries-home" class="space-y-2">
              <p class="text-[0.65rem] font-semibold uppercase tracking-wide text-slate-400 text-center md:text-left">
                Home Injuries (Quick)
              </p>
              <div class="flex items-center justify-center md:justify-start gap-4">
                <label class="inline-flex items-center cursor-pointer space-x-2">
                  <input id="home-major" type="checkbox" class="w-4 h-4 text-rose-600 bg-slate-800 border-slate-600 rounded focus:ring-rose-500 focus:ring-2">
                  <span class="text-xs text-slate-300">Major</span>
                </label>
                <label class="inline-flex items-center cursor-pointer space-x-2">
                  <input id="home-minor" type="checkbox" class="w-4 h-4 text-amber-500 bg-slate-800 border-slate-600 rounded focus:ring-amber-500 focus:ring-2">
                  <span class="text-xs text-slate-300">Minor</span>
                </label>
              </div>
            </div>

            <!-- Away Injuries (generic) -->
            <div id="generic-injuries-away" class="space-y-2">
              <p class="text-[0.65rem] font-semibold uppercase tracking-wide text-slate-400 text-center md:text-left">
                Away Injuries (Quick)
              </p>
              <div class="flex items-center justify-center md:justify-start gap-4">
                <label class="inline-flex items-center cursor-pointer space-x-2">
                  <input id="away-major" type="checkbox" class="w-4 h-4 text-rose-600 bg-slate-800 border-slate-600 rounded focus:ring-rose-500 focus:ring-2">
                  <span class="text-xs text-slate-300">Major</span>
                </label>
                <label class="inline-flex items-center cursor-pointer space-x-2">
                  <input id="away-minor" type="checkbox" class="w-4 h-4 text-amber-500 bg-slate-800 border-slate-600 rounded focus:ring-amber-500 focus:ring-2">
                  <span class="text-xs text-slate-300">Minor</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Position-specific injuries for NBA / NFL -->
          <div id="pos-injuries" class="hidden pt-4 border-t border-slate-800">
            <div class="grid md:grid-cols-2 gap-6">
              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <p class="text-[0.65rem] font-semibold uppercase tracking-wide text-slate-400">
                    Home Positional Injuries
                  </p>
                  <span class="text-[0.65rem] text-slate-500">NBA: PG/SG/SF/PF/C • NFL: QB/WR/TE/RB</span>
                </div>
                <div id="home-pos-fields" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                <textarea
                  id="home-injured-players"
                  class="w-full bg-slate-900/70 border border-slate-800 rounded-2xl px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-purple-500/70"
                  placeholder="Optional: list injured home players (comma-separated)"
                ></textarea>
              </div>

              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <p class="text-[0.65rem] font-semibold uppercase tracking-wide text-slate-400">
                    Away Positional Injuries
                  </p>
                  <span class="text-[0.65rem] text-slate-500">NBA & NFL only</span>
                </div>
                <div id="away-pos-fields" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                <textarea
                  id="away-injured-players"
                  class="w-full bg-slate-900/70 border border-slate-800 rounded-2xl px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-purple-500/70"
                  placeholder="Optional: list injured away players (comma-separated)"
                ></textarea>
              </div>
            </div>
          </div>
        </section>

        <!-- Button -->
        <div class="flex justify-center">
          <button
            id="run-btn"
            class="gradient-btn inline-flex items-center justify-center rounded-2xl px-7 py-2.5 text-xs md:text-sm font-black tracking-wide uppercase"
          >
            Run 500,000 Simulations
          </button>
        </div>

        <!-- Result Panel -->
        <section
          id="result"
          class="hidden bg-slate-900/70 border border-slate-800 rounded-3xl px-4 py-4 md:px-5 md:py-5 space-y-4"
        >
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
            <h3
              id="matchup"
              class="text-base md:text-lg font-extrabold bg-gradient-to-r from-yellow-300 via-pink-400 to-sky-300 bg-clip-text text-transparent"
            ></h3>
            <p id="winprob" class="text-xs md:text-sm font-semibold text-emerald-400"></p>
          </div>

          <div class="grid md:grid-cols-3 gap-3 text-xs md:text-sm">
            <div class="bg-slate-950/60 border border-slate-800 rounded-2xl p-3 space-y-1">
              <p class="text-[0.65rem] font-semibold uppercase tracking-wide text-slate-400">
                Projected Final Score
              </p>
              <p id="score" class="font-bold text-slate-50"></p>
            </div>

            <div class="bg-slate-950/60 border border-slate-800 rounded-2xl p-3 space-y-1">
              <p class="text-[0.65rem] font-semibold uppercase tracking-wide text-slate-400">
                Edge Summary
              </p>
              <p id="edge" class="font-semibold text-emerald-300"></p>
            </div>

            <div class="bg-slate-950/60 border border-slate-800 rounded-2xl p-3 space-y-1">
              <p class="text-[0.65rem] font-semibold uppercase tracking-wide text-slate-400">
                Best Bet
              </p>
              <p id="bet" class="font-semibold text-sky-300"></p>
            </div>
          </div>

          <div class="bg-slate-950/50 border border-slate-800 rounded-2xl p-3 md:p-4">
            <p class="text-[0.65rem] font-semibold uppercase tracking-wide text-slate-400 mb-1">
              Model Notes
            </p>
            <p id="explanation" class="text-xs md:text-sm leading-relaxed text-slate-200 whitespace-pre-line"></p>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    // ===== TEAM LISTS =====
    
    const teamCache = {};

    async function getTeamsForLeague(league) {
      if (teamCache[league]) return teamCache[league];
      
      try {
        const res = await fetch(`/data/${league.toLowerCase()}.json`);
        if (!res.ok) throw new Error("Failed to load league data");
        const data = await res.json();
        if (data.teams) {
          const teams = Object.keys(data.teams).sort();
          teamCache[league] = teams;
          return teams;
        }
      } catch (e) {
        console.error("Error fetching teams for", league, e);
      }
      return []; 
    }
const POSITION_SETS = {
      NBA: ["PG", "SG", "SF", "PF", "C"],
      NFL: ["QB", "WR", "TE", "RB"]
    };

    
    async function populateTeams() {
      const league = document.getElementById("league").value;
      const selectHome = document.getElementById("home-team");
      const selectAway = document.getElementById("away-team");
      
      // Show loading state if not cached
      if (!teamCache[league]) {
          const loading = "<option>Loading...</option>";
          selectHome.innerHTML = loading;
          selectAway.innerHTML = loading;
      }
      
      const teams = await getTeamsForLeague(league);
      
      const options = "<option>Select Team</option>" +
          teams.map(t => `<option>${t}</option>`).join("");
          
      selectHome.innerHTML = options;
      selectAway.innerHTML = options;
    }
function renderPositionInputs() {
      const league = document.getElementById("league").value;
      const positions = POSITION_SETS[league];
      const posSection = document.getElementById("pos-injuries");
      const genericHome = document.getElementById("generic-injuries-home");
      const genericAway = document.getElementById("generic-injuries-away");

      if (!positions) {
        posSection.classList.add("hidden");
        genericHome.classList.remove("hidden");
        genericAway.classList.remove("hidden");
        document.getElementById("home-pos-fields").innerHTML = "";
        document.getElementById("away-pos-fields").innerHTML = "";
        document.getElementById("home-injured-players").value = "";
        document.getElementById("away-injured-players").value = "";
        return;
      }

      posSection.classList.remove("hidden");
      genericHome.classList.add("hidden");
      genericAway.classList.add("hidden");

      const build = (containerId, prefix) => {
        const container = document.getElementById(containerId);
        container.innerHTML = positions
          .map(pos => `
            <label class="block text-xs text-slate-200 space-y-1">
              <span class="text-[0.7rem] font-semibold text-slate-400">${pos}</span>
              <select
                id="${prefix}-pos-${pos}"
                class="w-full bg-slate-900/70 border border-slate-800 rounded-xl px-2 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-purple-500/70"
              >
                <option value="none">None</option>
                <option value="minor">Minor</option>
                <option value="major">Major</option>
              </select>
            </label>
          `)
          .join("");
      };

      build("home-pos-fields", "home");
      build("away-pos-fields", "away");
    }

    function onLeagueChange() {
      populateTeams();
      renderPositionInputs();
    }

    document.getElementById("league").addEventListener("change", onLeagueChange);
    onLeagueChange(); // initial load

    function collectPositionInjuries(prefix, positions) {
      const pos = {};
      positions.forEach(p => {
        const el = document.getElementById(`${prefix}-pos-${p}`);
        if (el) pos[p] = el.value;
      });
      const playerEl = document.getElementById(`${prefix}-injured-players`);
      const players =
        playerEl && playerEl.value
          ? playerEl.value
              .split(",")
              .map(v => v.trim())
              .filter(Boolean)
          : [];
      return { positions: pos, players };
    }

    document.addEventListener("click", async e => {
      if (e.target.id !== "run-btn") return;

      const league = document.getElementById("league").value;
      const home = document.getElementById("home-team").value;
      const away = document.getElementById("away-team").value;

      if (!home || !away || home.includes("Select") || away.includes("Select")) {
        alert("Please select both teams.");
        return;
      }

      // Optional odds
      const homeMlVal = document.getElementById("home-ml").value.trim();
      const awayMlVal = document.getElementById("away-ml").value.trim();
      const spreadVal = document.getElementById("spread-line").value.trim();
      const totalVal = document.getElementById("total-line").value.trim();

      const homeMl = homeMlVal === "" ? NaN : parseInt(homeMlVal, 10);
      const awayMl = awayMlVal === "" ? NaN : parseInt(awayMlVal, 10);
      const spread = spreadVal === "" ? NaN : parseFloat(spreadVal);
      const total = totalVal === "" ? NaN : parseFloat(totalVal);

      const payload = { league, homeTeam: home, awayTeam: away };
      const market = {};
      let hasMarket = false;

      if (!isNaN(homeMl) && !isNaN(awayMl)) {
        market.homeMoneyline = homeMl;
        market.awayMoneyline = awayMl;
        hasMarket = true;
      }
      if (!isNaN(spread)) {
        market.spread = spread;
        hasMarket = true;
      }
      if (!isNaN(total)) {
        market.total = total;
        hasMarket = true;
      }
      if (hasMarket) {
        payload.market = market;
      }

      // Context inputs
      payload.neutralSite = document.getElementById("neutral-site").checked;
      const posList = POSITION_SETS[league];
      if (posList) {
        const homePos = collectPositionInjuries("home", posList);
        const awayPos = collectPositionInjuries("away", posList);
        payload.homePositionInjuries = homePos.positions;
        payload.awayPositionInjuries = awayPos.positions;
        if (homePos.players.length) payload.homeInjuredPlayers = homePos.players;
        if (awayPos.players.length) payload.awayInjuredPlayers = awayPos.players;
        // legacy flags off when using positional inputs
        payload.homeMajorInjury = false;
        payload.homeMinorInjury = false;
        payload.awayMajorInjury = false;
        payload.awayMinorInjury = false;
      } else {
        payload.homeMajorInjury = document.getElementById("home-major").checked;
        payload.homeMinorInjury = document.getElementById("home-minor").checked;
        payload.awayMajorInjury = document.getElementById("away-major").checked;
        payload.awayMinorInjury = document.getElementById("away-minor").checked;
      }

      const btn = e.target;
      btn.disabled = true;
      btn.textContent = "Running sims...";

      try {
        const res = await fetch("/.netlify/functions/predict", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        // matchup
        document.getElementById("matchup").textContent =
          data.matchup || `${away} @ ${home}`;

        // scores (works for BOTH: new + old backend)
        let homeScore = data.projectedHomeScore;
        let awayScore = data.projectedAwayScore;

        if (
          (homeScore === undefined || awayScore === undefined) &&
          typeof data.projectedScore === "string"
        ) {
          const parts = data.projectedScore.split(/[-–]/).map(p => p.trim());
          if (parts.length === 2) {
            homeScore = parseInt(parts[0], 10);
            awayScore = parseInt(parts[1], 10);
          }
        }

        if (isNaN(homeScore) || isNaN(awayScore)) {
          document.getElementById("score").textContent =
            data.projectedScore || "";
        } else {
          document.getElementById("score").textContent =
            `${data.homeTeam || home} ${homeScore} – ` +
            `${data.awayTeam || away} ${awayScore}`;
        }

        document.getElementById("winprob").textContent =
          data.winProbability || "";
        document.getElementById("edge").textContent = data.edge || "";
        document.getElementById("bet").textContent =
          data.recommendedBet || "No clear best bet.";

        document.getElementById("explanation").textContent =
          data.explanation || "";

        const result = document.getElementById("result");
        result.classList.remove("hidden");
        result.scrollIntoView({ behavior: "smooth", block: "start" });
      } catch (err) {
        console.error(err);
        alert("Simulation request failed or timed out. Please try again.");
      }

      btn.disabled = false;
      btn.textContent = "Run 500,000 Simulations";
    });
  </script>
</body>
</html>
