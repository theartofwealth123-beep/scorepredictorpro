<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sports Score Predictor Pro</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 50%, #4338ca 100%);
      min-height: 100vh;
      padding: 20px;
      color: white;
    }

    .container { max-width: 1200px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 20px; }
    h1 { font-size: 2.4rem; margin-bottom: 8px; }
    .subtitle { color: #93c5fd; font-size: 1.05rem; }

    /* Top bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .brand {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      opacity: 0.95;
    }

    .auth-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 0.9rem;
    }

    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: 0.15s ease;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.5);
      color: white;
    }
    .btn-outline:hover { background: rgba(255,255,255,0.1); }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      color: white;
    }
    .btn-primary:hover { transform: scale(1.05); }

    .btn-danger {
      background: rgba(239, 68, 68, 0.95);
      color: white;
    }
    .btn-danger:hover { opacity: 0.8; }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(16, 185, 129, 0.5);
      margin-left: 6px;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-backdrop.show { display: flex; }

    .modal {
      background: #020617;
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 380px;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 20px 40px rgba(0,0,0,0.55);
    }

    input[type="email"], input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.8);
      color: white;
      font-size: 0.9rem;
    }

    .error-text {
      color: #fecaca;
      margin-top: 4px;
      font-size: 0.8rem;
      min-height: 1em;
    }

    /* Paywall */
    .paywall-card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid rgba(251,191,36,0.85);
    }

    .input-section {
      background: rgba(255,255,255,0.12);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 24px;
      backdrop-filter: blur(10px);
    }

    label { font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }

    select {
      padding: 10px;
      border-radius: 10px;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
    }

    select option { background: #1e3a8a; }

    .predict-btn {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      border: none;
      color: white;
      font-size: 1.1rem;
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      cursor: pointer;
      transition: 0.15s ease;
    }
    .predict-btn:hover { transform: scale(1.03); }

    /* Results */
    .results { display: none; }
    .results.show { display: block; }

    .score-card {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 24px;
      text-align: center;
    }

    .team-score {
      background: rgba(255,255,255,0.2);
      padding: 22px;
      border-radius: 15px;
    }

    .score {
      font-size: 3.2rem;
      font-weight: 700;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .stat-card {
      background: rgba(255,255,255,0.1);
      padding: 22px;
      border-radius: 20px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      h1 { font-size: 1.9rem; }
      .score { font-size: 2.5rem; }
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Top Bar -->
    <div class="top-bar">
      <div class="brand">ScorePredictor Pro</div>
      <div class="auth-buttons" id="authControls"></div>
    </div>

    <!-- Header -->
    <div class="header">
      <h1>âš¡ Sports Score Predictor</h1>
      <p class="subtitle">Advanced Statistical Analysis & Member-Only Predictions</p>
    </div>

    <!-- PAYWALL -->
    <div id="paywall">
      <div class="paywall-card">
        <div class="paywall-badge">3-Day Free Trial</div>

        <h2 style="margin-bottom:8px;">Unlock ScorePredictor Pro</h2>
        <p class="paywall-subtitle">
          Start your free trial â€” no credit card required.  
          Admin login always has unlimited access.
        </p>

        <ul class="paywall-list">
          <li>Predict NFL, NBA, MLB, NCAAF, and NCAAB games.</li>
          <li>Real statistical models using efficiency indexes.</li>
          <li>Daily auto-updated stats (serverless scraping).</li>
          <li>Private admin mode for unrestricted usage.</li>
        </ul>

        <button class="btn btn-primary" onclick="openAuthModal('signup')">Start Free Trial</button>
        <button class="btn btn-outline" onclick="openAuthModal('login')" style="margin-top:8px;">
          Log In
        </button>

        <p id="trialStatusText" class="trial-status"></p>
      </div>
    </div>

    <!-- MAIN APP (Requires Login) -->
    <div id="appContent" style="display:none;">

      <!-- Input Panel -->
      <div class="input-section">
        <div class="form-grid">

          <div class="form-group">
            <label>League</label>
            <select id="league">
              <option value="NFL">NFL</option>
              <option value="NBA">NBA</option>
              <option value="MLB">MLB</option>
              <option value="NCAAF">NCAAF</option>
              <option value="NCAAB">NCAAB</option>
            </select>
          </div>

          <div class="form-group">
            <label>Home Team</label>
            <select id="homeTeam">
              <option value="">Loading teamsâ€¦</option>
            </select>
          </div>

          <div class="form-group">
            <label>Away Team</label>
            <select id="awayTeam">
              <option value="">Loading teamsâ€¦</option>
            </select>
          </div>
        </div>

        <button class="predict-btn" onclick="predictScore()">ðŸŽ¯ Generate Prediction</button>
      </div>

      <!-- RESULTS -->
      <div id="results" class="results">

        <!-- Score Card -->
        <div class="score-card">
          <h2>Predicted Final Score</h2>

          <div class="confidence" id="confidence"></div>

          <div class="scores" style="display:grid;grid-template-columns:1fr auto 1fr;gap:20px;margin-top:20px;">

            <div class="team-score">
              <div class="team-name" id="homeTeamName"></div>
              <div class="score" id="homeScore"></div>
              <div style="opacity:0.8;margin-top:5px;">Home</div>
            </div>

            <div class="winner-info" style="text-align:center;">
              <div style="opacity:0.7;">Winner</div>
              <div class="winner-name" id="winner"></div>
              <div id="spread" style="opacity:0.75;margin-top:4px;"></div>
            </div>

            <div class="team-score">
              <div class="team-name" id="awayTeamName"></div>
              <div class="score" id="awayScore"></div>
              <div style="opacity:0.8;margin-top:5px;">Away</div>
            </div>

          </div>
        </div>

        <!-- Team Stats Comparison -->
        <div class="stats-grid">

          <div class="stat-card">
            <h3 id="homeStatsTitle"></h3>
            <div id="homeStats"></div>
          </div>

          <div class="stat-card">
            <h3 id="awayStatsTitle"></h3>
            <div id="awayStats"></div>
          </div>

        </div>

        <!-- Methodology -->
        <div class="methodology">
          <h3>Model Explanation</h3>
          <p>
            Our model blends offensive/defensive efficiency, pace, form index,
            strength of schedule, and home-field advantage into a unified prediction.
          </p>
          <p id="reasoningText" style="opacity:0.9;margin-top:10px;"></p>
        </div>

      </div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div id="authModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2 id="authModalTitle">Sign in</h2>
      <p class="modal-desc" id="authModalDesc"></p>

      <div class="form-group">
        <label>Email</label>
        <input type="email" id="authEmail" placeholder="you@example.com" />
      </div>

      <div class="form-group">
        <label>Password</label>
        <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
      </div>

      <div id="authError" class="error-text"></div>

      <div class="modal-actions">
        <button id="authPrimaryBtn" class="btn btn-primary"></button>
        <button class="btn btn-outline" onclick="closeAuthModal()">Cancel</button>
      </div>

      <div class="modal-footer-text">
        <span id="authToggleText"></span>
        <span class="link" id="authToggleLink" onclick="toggleAuthMode()"></span>
      </div>
    </div>
  </div>
<script>
/*************************************************
 *                 AUTH SYSTEM
 *************************************************/
const ADMIN_EMAIL = "ben_sovilla@yahoo.com";
const TRIAL_DAYS = 3;
let authMode = "login";

function getUsers() {
  return JSON.parse(localStorage.getItem("sp_users") || "{}");
}
function saveUsers(users) {
  localStorage.setItem("sp_users", JSON.stringify(users));
}

function getCurrentUser() {
  return JSON.parse(localStorage.getItem("sp_currentUser") || "null");
}
function setCurrentUser(user) {
  if (user) localStorage.setItem("sp_currentUser", JSON.stringify(user));
  else localStorage.removeItem("sp_currentUser");

  renderAuthUI();
  checkAccessAndRender();
}

function isTrialActive(user) {
  if (!user || !user.trialStart) return false;
  const start = new Date(user.trialStart).getTime();
  const now = Date.now();
  return (now - start) / 86400000 < TRIAL_DAYS;
}

function userHasAccess(user) {
  if (!user) return false;
  if (user.isAdmin || user.isSubscribed || isTrialActive(user)) return true;
  return false;
}

function remainingTrialText(user) {
  const start = new Date(user.trialStart).getTime();
  const now = Date.now();
  const expires = start + TRIAL_DAYS * 86400000;
  const diff = expires - now;

  if (diff <= 0) return "Your free trial has expired.";
  const days = Math.floor(diff / 86400000);
  const hours = Math.floor((diff % 86400000) / 3600000);
  return `Trial active: ${days}d ${hours}h left`;
}

function renderAuthUI() {
  const user = getCurrentUser();
  const ctrl = document.getElementById("authControls");
  const trialText = document.getElementById("trialStatusText");

  if (!user) {
    ctrl.innerHTML = `
      <button class="btn btn-outline" onclick="openAuthModal('login')">Log In</button>
      <button class="btn btn-primary" onclick="openAuthModal('signup')">Start Free Trial</button>
    `;
    trialText.textContent = "Not signed in.";
    return;
  }

  const badge = user.isAdmin
    ? `<span class="badge">Admin</span>`
    : user.isSubscribed
    ? `<span class="badge">Subscriber</span>`
    : `<span class="badge">Trial</span>`;

  ctrl.innerHTML = `
      <div class="user-label">Signed in as ${user.email}${badge}</div>
      ${
        !user.isAdmin && !user.isSubscribed
          ? `<button class="btn btn-primary" onclick="fakeSubscribe()">Subscribe now</button>`
          : ""
      }
      <button class="btn btn-danger" onclick="logout()">Log out</button>
  `;

  trialText.textContent = user.isAdmin
    ? "Admin access."
    : user.isSubscribed
    ? "Subscription active."
    : remainingTrialText(user);
}

function checkAccessAndRender() {
  const user = getCurrentUser();
  const app = document.getElementById("appContent");
  const paywall = document.getElementById("paywall");

  if (userHasAccess(user)) {
    app.style.display = "block";
    paywall.style.display = "none";
  } else {
    paywall.style.display = "block";
    app.style.display = "none";
  }
}

function openAuthModal(mode) {
  authMode = mode;
  const backdrop = document.getElementById("authModalBackdrop");
  const title = document.getElementById("authModalTitle");
  const desc = document.getElementById("authModalDesc");
  const btn = document.getElementById("authPrimaryBtn");
  const toggleText = document.getElementById("authToggleText");
  const toggleLink = document.getElementById("authToggleLink");

  document.getElementById("authEmail").value = "";
  document.getElementById("authPassword").value = "";
  document.getElementById("authError").textContent = "";

  if (mode === "login") {
    title.textContent = "Log In";
    desc.textContent = "Access ScorePredictor Pro";
    btn.textContent = "Log in";
    toggleText.textContent = "Don't have an account?";
    toggleLink.textContent = "Create one";
  } else {
    title.textContent = "Create Account";
    desc.textContent = "Start your 3-day free trial.";
    btn.textContent = "Create Account";
    toggleText.textContent = "Already have an account?";
    toggleLink.textContent = "Log in";
  }

  btn.onclick = handleAuthSubmit;
  backdrop.classList.add("show");
}

function closeAuthModal() {
  document.getElementById("authModalBackdrop").classList.remove("show");
}

function toggleAuthMode() {
  openAuthModal(authMode === "login" ? "signup" : "login");
}

function handleAuthSubmit() {
  const email = document.getElementById("authEmail").value.trim().toLowerCase();
  const password = document.getElementById("authPassword").value;
  const error = document.getElementById("authError");

  if (!email || !password) {
    error.textContent = "Enter email and password.";
    return;
  }

  const users = getUsers();

  if (authMode === "signup") {
    if (users[email]) {
      error.textContent = "Account already exists.";
      return;
    }

    users[email] = {
      email,
      password,
      isAdmin: email === ADMIN_EMAIL,
      isSubscribed: false,
      trialStart: new Date().toISOString()
    };

    saveUsers(users);
    setCurrentUser(users[email]);
    closeAuthModal();
    return;
  }

  if (!users[email] || users[email].password !== password) {
    error.textContent = "Invalid email or password.";
    return;
  }

  setCurrentUser(users[email]);
  closeAuthModal();
}

function logout() {
  setCurrentUser(null);
}

function fakeSubscribe() {
  const user = getCurrentUser();
  const users = getUsers();
  users[user.email].isSubscribed = true;
  saveUsers(users);
  setCurrentUser(users[user.email]);
  alert("Subscription activated (demo mode)");
}

/*************************************************
 *                 TEAM LOADING
 *************************************************/

let ALL_TEAMS = {};
let ALL_STATS = {};
let teamsReady = false;

async function loadAllTeams() {
  try {
    const res = await fetch("/data/all-teams.json");
    if (!res.ok) throw new Error("all-teams.json missing");
    ALL_TEAMS = await res.json();
    teamsReady = true;
    populateTeamDropdowns();
  } catch (err) {
    alert("Error loading team list: " + err.message);
  }
}

function populateTeamDropdowns() {
  const league = document.getElementById("league").value;
  const homeSel = document.getElementById("homeTeam");
  const awaySel = document.getElementById("awayTeam");

  const teams = ALL_TEAMS[league] || [];

  homeSel.innerHTML = `<option value="">Select Home Team</option>`;
  awaySel.innerHTML = `<option value="">Select Away Team</option>`;

  teams.forEach(t => {
    const h = document.createElement("option");
    h.value = t;
    h.textContent = t;

    const a = h.cloneNode(true);

    homeSel.appendChild(h);
    awaySel.appendChild(a);
  });
}

/*************************************************
 *          FETCH LIVE STATS (Netlify Function)
 *************************************************/
async function fetchTeamStats(league, team) {
  const url = `/.netlify/functions/team-stats?league=${encodeURIComponent(
    league
  )}&team=${encodeURIComponent(team)}`;

  const res = await fetch(url);
  if (!res.ok) throw new Error(`(${res.status}) Failed for ${team}`);

  const data = await res.json();
  if (data.error) throw new Error(data.error);

  return data;
}

/*************************************************
 *                 PREDICTION ENGINE
 *************************************************/
const leagueConfig = {
  NFL: { avgPoints: 22, std: 10, homeAdv: 2.5 },
  NBA: { avgPoints: 114, std: 15, homeAdv: 3.0 },
  MLB: { avgPoints: 4.5, std: 3, homeAdv: 0.3 },
  NCAAF: { avgPoints: 29, std: 12, homeAdv: 3.5 },
  NCAAB: { avgPoints: 71, std: 12, homeAdv: 3.8 },
};

function round1(x) {
  return Math.round(x * 10) / 10;
}

function simulateScore(home, away, league) {
  const cfg = leagueConfig[league];
  const base = cfg.avgPoints * 2;

  const env =
    ((home.pace_index + away.pace_index) / 2) *
    ((home.sos_index + away.sos_index) / 2);

  const match =
    (home.off_index / away.def_index +
      away.off_index / home.def_index) /
    2;

  const rawTotal = base * env * match;
  const homeAdv = home.home_adv_points ?? cfg.homeAdv;

  const homeW =
    (home.off_index / away.def_index) *
    home.form_index *
    (1 + homeAdv / rawTotal);

  const awayW = (away.off_index / home.def_index) * away.form_index;

  const weightSum = homeW + awayW;

  const homeScore = round1(rawTotal * (homeW / weightSum));
  const awayScore = round1(rawTotal * (awayW / weightSum));

  return {
    homeScore,
    awayScore,
    winner: homeScore >= awayScore ? home.team : away.team,
    spread: round1(Math.abs(homeScore - awayScore)),
    confidence:
      Math.abs(homeScore - awayScore) >= cfg.std * 0.6
        ? "High"
        : Math.abs(homeScore - awayScore) >= cfg.std * 0.3
        ? "Medium"
        : "Low",
  };
}

/*************************************************
 *           BUTTON HANDLER: PREDICT
 *************************************************/
async function predictScore() {
  const league = document.getElementById("league").value;
  const home = document.getElementById("homeTeam").value;
  const away = document.getElementById("awayTeam").value;

  if (!home || !away) {
    alert("Choose Home and Away teams.");
    return;
  }
  if (home === away) {
    alert("Teams must be different.");
    return;
  }

  try {
    document.getElementById("confidence").textContent = "Loading statsâ€¦";

    const [homeStats, awayStats] = await Promise.all([
      fetchTeamStats(league, home),
      fetchTeamStats(league, away),
    ]);

    const result = simulateScore(homeStats, awayStats, league);

    // Update UI
    document.getElementById("homeTeamName").textContent = home;
    document.getElementById("awayTeamName").textContent = away;

    document.getElementById("homeScore").textContent = result.homeScore;
    document.getElementById("awayScore").textContent = result.awayScore;

    document.getElementById("winner").textContent = result.winner;
    document.getElementById("spread").textContent =
      "Spread: " + result.spread;

    document.getElementById("confidence").textContent =
      result.confidence + " confidence";

    document.getElementById("homeStatsTitle").textContent =
      home + " Profile";
    document.getElementById("awayStatsTitle").textContent =
      away + " Profile";

    document.getElementById("homeStats").innerHTML = `
      <div class="stat-row"><span>Off Index</span><span>${homeStats.off_index.toFixed(3)}</span></div>
      <div class="stat-row"><span>Def Index</span><span>${homeStats.def_index.toFixed(3)}</span></div>
      <div class="stat-row"><span>Pace Index</span><span>${homeStats.pace_index.toFixed(3)}</span></div>
      <div class="stat-row"><span>SOS Index</span><span>${homeStats.sos_index.toFixed(3)}</span></div>
      <div class="stat-row"><span>Form Index</span><span>${homeStats.form_index.toFixed(3)}</span></div>
      <div class="stat-row"><span>PPG</span><span>${homeStats.ppg.toFixed(1)}</span></div>
      <div class="stat-row"><span>Opp PPG</span><span>${homeStats.opp_ppg.toFixed(1)}</span></div>
    `;

    document.getElementById("awayStats").innerHTML = `
      <div class="stat-row"><span>Off Index</span><span>${awayStats.off_index.toFixed(3)}</span></div>
      <div class="stat-row"><span>Def Index</span><span>${awayStats.def_index.toFixed(3)}</span></div>
      <div class="stat-row"><span>Pace Index</span><span>${awayStats.pace_index.toFixed(3)}</span></div>
      <div class="stat-row"><span>SOS Index</span><span>${awayStats.sos_index.toFixed(3)}</span></div>
      <div class="stat-row"><span>Form Index</span><span>${awayStats.form_index.toFixed(3)}</span></div>
      <div class="stat-row"><span>PPG</span><span>${awayStats.ppg.toFixed(1)}</span></div>
      <div class="stat-row"><span>Opp PPG</span><span>${awayStats.opp_ppg.toFixed(1)}</span></div>
    `;

    document.getElementById("reasoningText").textContent = `
      The model adjusts for offensive efficiency, defensive resistance, pace,
      strength of schedule, form trends, and home-field advantage to calculate
      projected scoring distribution.
    `;

    document.getElementById("results").classList.add("show");
    document.getElementById("results").scrollIntoView({ behavior: "smooth" });

  } catch (err) {
    console.error(err);
    alert("Could not load stats: " + err.message);
  }
}

/*************************************************
 *                   INIT
 *************************************************/
document.addEventListener("DOMContentLoaded", () => {
  renderAuthUI();
  checkAccessAndRender();
  loadAllTeams();

  document.getElementById("league").addEventListener("change", () => {
    if (teamsReady) populateTeamDropdowns();
  });
});
</script>
